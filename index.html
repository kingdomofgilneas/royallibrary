<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gilnean Royal Library</title>
    <link rel="icon" type="image/png" href="assets/seal.png">
    
    <style>
      /* General Page Styles */
      :root{ --darknavy:#202241; --lightnavy:#2f3266; --gold:#fbac3a; --red:#b22025;  --lightgrey:#dddddd; --beige:#8d6339; --midgrey:#464646; --darkgrey:#303030;}
      html,body{height:100%;}
      body{margin:0;background:var(--darknavy);color:var(--darknavy2);font-family:"Garamond","Georgia",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
      
      /* Home Office Header Area (Left) */
      .topbar{display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px dashed rgba(255,255,255,.15)}
      .topbar .seal{ width:60px; height:60px; border-radius:50%; object-fit:cover; display:inline-block; box-shadow:0 0 0 2px rgba(255,255,255,0.15) inset; }
      @media (max-width:480px){ .topbar .seal{ width:60px; height:60px; } }
      .topbar .ministry{opacity:.9;font-size:26px;letter-spacing:.3px;color: var(--lightgrey);}
      .wrap{max-width:1100px;margin:0 auto;padding:0 24px 48px}

      /* Submit Button (Top Right) */
      .submit-btn {
        margin-left: auto;
        background: var(--gold);
        color: var(--darknavy);
        text-decoration: none;
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 18px;
        box-shadow: 0 2px 6px rgba(0,0,0,.25);
        transition: background .2s ease, transform .1s ease;
      }
      .submit-btn:hover {
        background: #e6ae46;
        transform: translateY(-1px);
      }
      .submit-btn:active {
        transform: translateY(0);
      }
      @media (max-width:480px){
        .submit-btn{
          font-size: 14px;
          padding: 8px 12px;
        }
      }
      
      /* Library Title Area */
      .title{text-align:center;margin:28px 0 10px;font-size:54px;letter-spacing:2px;color:var(--gold);font-weight:600;text-transform:uppercase}
      .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);margin:18px 0 26px}
      .section-title{text-align:center;color:var(--gold);font-size:24px;letter-spacing:1px;text-transform:uppercase;margin:10px 0 14px; font-weight:600;}

      /* Search Bar */
      .search-wrap{display:flex;justify-content:center;margin:8px 0 18px}
      .search{
        width:min(680px,100%);display:flex;gap:10px;
        background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);
        border-radius:10px;padding:10px 12px
      }
      .search input{ flex:1;background:transparent;border:0;outline:none;color:#fff;font-size:16px;letter-spacing:.2px }
      .search button{ background:var(--gold);border:0;border-radius:8px;color:#2b2f5e;padding:8px 12px;font-weight:600;cursor:pointer }
      .search input::placeholder{color:#cfd3e6}
      .search input:disabled{opacity:.6}
      .search .clear{background:transparent;border:1px solid rgba(255,255,255,.35);color:#fff}
      
      /* Buttons */
      button.clear{
        background: transparent;
        border: 1px solid rgba(255,255,255,.35);
        color: #fff;
        border-radius: 8px;
        padding: 8px 12px;
        font-weight: 600;
        cursor: pointer;
      }
      button.clear:hover{
        border-color: rgba(255,255,255,.55);
      }
      button.clear:disabled{
        opacity: .6;
        cursor: not-allowed;
      }
      button.clear {
        font-size: 16px;             
        letter-spacing: .2px;       
        transition: border-color .2s ease, opacity .2s ease;
      }

      /* Filters (Category + Sub-category) */
      .filters{ display:flex; gap:16px; align-items:flex-start; justify-content:center; margin:8px 0 10px; }
      .filter{ display:flex; flex-direction:column; min-width:220px; }
      .filter label{ font-size:14px; color:#cfd3e6; margin:0 0 6px 2px; letter-spacing:.3px; }
      #clearFilters{ align-self:flex-end; height:36px; margin-top:22px; }
      @media (max-width:820px){ .filters{ flex-direction:column; align-items:center; } .filter{ width:min(680px,100%); } #clearFilters{ align-self:center; } }

      /* Filter Bar (Search + Cat filters) */
      .controls{
        display:flex;
        gap:16px;
        align-items:flex-end;   /* Important for lining up inputs/buttons */
        justify-content:center;
        flex-wrap:wrap;  
        margin:8px 0 18px;
      }
      .controls .filter{
        display:flex;
        flex-direction:column;
        min-width:220px;
      }
      .controls .search{
        flex:1 1 360px;  
        max-width:680px;
        display:flex;
        gap:10px;
        background:rgba(255,255,255,.06);
        border:1px solid rgba(255,255,255,.18);
        border-radius:10px;
        padding:10px 12px;
      }
      #clearFilters{
        height:36px;
        align-self:flex-end;
        margin:0;
      }
      
      /* Mobile Fixes */
      @media (max-width:820px){
        #clearFilters{ align-self:center; }
      }
      
      /* Genre buttons */
      .genre-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:26px;margin:18px 0 12px; padding-bottom:10px;}
      .genre-btn{
        background:var(--lightgrey);color:var(--lightnavy);border:0;border-radius:8px;padding:14px 18px;font-size:18px;
        cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.25);
        transition:transform .08s ease,box-shadow .2s ease,background .2s ease;
        font-family:"Garamond","Georgia",serif; font-weight: 700;
      }
      .genre-btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.35)}
      .genre-btn.active{outline:2px solid var(--gold);background:#fffdf7}

      /* Sub-list */
      .sublist{margin-top:24px;background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.18);border-radius:10px;padding:16px 18px}
      .sublist h3{margin:0 0 10px;font-weight:600;color:#f1e5cf;letter-spacing:.5px}
      .items{list-style:none;padding:0;margin:0}
      .items li{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.09)}
      .items li:last-child{border-bottom:0}
      .items a{color:var(--gold);text-decoration:none;font-size:22px;font-weight:500;}
      .items a:hover{text-decoration:underline}
      .empty{color:#cbd0ea;font-style:italic;padding:6px 2px}
      .footer{margin-top:10px;color:#c8cdeb;font-size:13px}
      .err{margin-top:12px;color:#ffb3b3;white-space:pre-wrap;font-size:13px}

      /* Meta lines (author + date + TRP Import) */
      .meta{ display:flex; justify-content:space-between; align-items:center; margin-top:2px; color:#c8cdeb; font-size:18px; line-height:1.4; width:100%; }
      .meta .left,.meta .right{ display:inline-block; }
      .meta .left{ text-align:left; }
      .meta .right{ text-align:right; margin-left:auto; }
      .meta .trp {
        font-style: italic;
        color: #e0d9c7;
        font-size: 13px;
        margin-top: 2px;
      }
      .copy-trp {
        background: transparent;
        border: 1px solid rgba(255,255,255,.35);
        color: #fff;
        border-radius: 6px;
        padding: 3px 10px;
        font-size: 13px;
        font-style: italic;
        cursor: pointer;
        transition: all .2s ease;
      }
      .copy-trp:hover {
        border-color: var(--gold);
        color: var(--gold);
      }
      .copy-trp:disabled {
        opacity: .6;
        cursor: not-allowed;
      }
      @media (max-width:600px){ .meta{ flex-direction:column; align-items:flex-start; gap:2px; } .meta .right{ margin-left:0; text-align:left; } }

      /* Sparkle Generator */
      #loader{ position:fixed; inset:0; background:radial-gradient(circle at center,#2e3264 0%,#1a1c35 100%); display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:999; color:#f7f1e8; font-family:"Garamond","Georgia",serif; text-align:center; letter-spacing:1px; transition:opacity .8s ease, visibility .8s ease; }
      #sparkles{ font-size:18px; white-space:pre; animation: sparklePulse 1.5s ease-in-out infinite; line-height:1.6em; }
      @keyframes sparklePulse{ 0%{opacity:.4;transform:scale(1)}50%{opacity:1;transform:scale(1.05)}100%{opacity:.4;transform:scale(1)} }
      #loader.fade{ opacity:0; visibility:hidden; }

      /* Multi Select Dropdown for Filters */
      .msel{ position:relative; min-width:220px; }
      .msel .control{
        width:100%; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18);
        color:#f7f1e8; border-radius:10px; padding:10px 12px; text-align:left; cursor:pointer; font:inherit;
      }
      .msel.disabled .control{ opacity:.6; cursor:not-allowed; }
      .msel .menu{
        position:absolute; top:100%; left:0; right:0; background:#2e3264; border:1px solid rgba(255,255,255,.18);
        border-radius:10px; margin-top:6px; max-height:220px; overflow:auto; display:none; z-index:100; box-shadow:0 10px 24px rgba(0,0,0,.35);
      }
      .msel.open .menu{ display:block; }
      .msel .row{ display:flex; align-items:center; gap:8px; padding:8px 10px; }
      .msel .row:hover{ background:rgba(255,255,255,.06); }
      .msel input[type="checkbox"]{ accent-color:var(--gold); }
      .msel .placeholder{ opacity:.8; }
      .panel-head{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin:0 0 10px;
      }

      /* Sorting Dropdown */
      .sorter{
        display:flex;
        align-items:center;
        gap:8px;
        color:#cfd3e6;
      }
      .sorter select{
        background:rgba(255,255,255,.06);
        border:1px solid rgba(255,255,255,.18);
        color:#f7f1e8;
        border-radius:10px;
        padding:6px 10px;
      }
      .sorter select:disabled{ opacity:.6; cursor:not-allowed; }
      .sorter select option {
        color: #444444;   /* FIx when menu is open */
      }
    </style>
  </head>
  <body>
    <div id="loader">
      <pre id="sparkles"></pre>
    </div>

    <div class="topbar">
      <img class="seal" src="assets/seal.png" alt="Ministry of the Home Office Seal" loading="lazy" />
      <div class="ministry">Ministry of the Home Office</div>
      <a class="submit-btn" href="https://docs.google.com/forms/d/e/1FAIpQLSc99A7brY4Ur1eXx9KtcYam1LH4R_ZlRiNqJehKzd_kKN_-PA/viewform" target="_blank" rel="noopener noreferrer">
        Submit a New Document
      </a>
    </div>

    <div class="wrap">
      <div class="title">Gilnean Royal Library</div>
      <div class="divider"></div>

      <div class="section-title">Genre Selection</div>

      <div id="genres" class="genre-row"></div>
      
      <div class="controls">
        <div class="search">
          <input id="q" type="text" placeholder="Filter by title, author..." disabled>
          <button id="clear" class="clear" disabled>Clear</button>
        </div>
      
        <div class="filter">
          <label>Category</label>
          <div id="catMS" class="msel" data-label="Category" data-plural="Categories"></div>

        </div>
      
        <div class="filter">
          <label>Sub-category</label>
          <div id="subMS" class="msel" data-label="Sub-category" data-plural="Sub-categories"></div>
        </div>
      
        <button id="clearFilters" class="clear" disabled>Clear Filters</button>
      </div>

      <div id="panel" class="sublist" style="display:none;">
        <div class="panel-head">
          <h3 id="panelTitle">Selected Genre</h3>
          <div class="sorter">
            <label for="sortSel">Sort</label>
            <select id="sortSel" disabled>
              <option value="title-asc">Title A–Z</option>
              <option value="title-desc">Title Z–A</option>
              <option value="date-newest">Newest</option>
              <option value="date-oldest">Oldest</option>
            </select>
          </div>
        </div>
      
        <ul id="items" class="items"></ul>
        <div id="footer" class="footer"></div>
        <div id="err" class="err"></div>
      </div>

    </div>

    <script>
      // Randomized loading messages
      const loadingMessages = [
        "⊹  The Library awakens...  ⊹",
        "✦   Dusting the tomes...  ✦",
        "⋆ Organizing the archives... ⋆",
        "✶  Fetching manuscripts...  ✶",
        "⋄ Translating from Old Gilnean... ⋄",
        "⚜  Badgering Parliament...  ⚜",
        "✦ Sorting quills and parchment... ✦",
        "✦ Looking for my spectacles... ✦"
      ];
      
      // Randomly select and build Sparkle loading message
      document.addEventListener("DOMContentLoaded", () => {
        const msg = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
        const sparkles = document.getElementById("sparkles");
        if (sparkles) {
          sparkles.textContent = ` ✨  ✶  ✨  ✶  ✨\n ${msg}\n ✨  ⋆  ✨  ⋆  ✨`;
        }
      });

      // Data Source
      const API = 'https://script.google.com/macros/s/AKfycbyrsTDK1h5DJfyZkzL1Wocp3Axy8TfBEbLCkB-4FTxG3wN9Dhv2_EZ2Xau7gBk1TsDT/exec';

      // States
      let rows = [];
      let byGenre = new Map();
      let activeGenre = null;
      let currentItems = [];
      let catSubIndex = new Map();

      // Elements
      let genresEl, panelEl, titleEl, listEl, footerEl, errEl;
      let qEl, clearEl, clearFiltersBtn;
      let catMS, subMS;
      let sortSel;

      // Initiate / Load
      window.addEventListener('load', () => {
        // Post-DOM Load
        genresEl  = document.getElementById('genres');
        panelEl   = document.getElementById('panel');
        titleEl   = document.getElementById('panelTitle');
        listEl    = document.getElementById('items');
        footerEl  = document.getElementById('footer');
        errEl     = document.getElementById('err');
        qEl       = document.getElementById('q');
        clearEl   = document.getElementById('clear');
        clearFiltersBtn = document.getElementById('clearFilters');
        sortSel = document.getElementById('sortSel');
        sortSel.addEventListener('change', () => applyFilter());

        // Build custom Multi-Select controls
        catMS = makeMultiselect(document.getElementById('catMS'), { onChange: handleCategoryChange });
        subMS = makeMultiselect(document.getElementById('subMS'));
        catMS.setDisabled(true);
        subMS.setDisabled(true);
        clearFiltersBtn.disabled = true;

        // This is just a precaution in case things take more time.
        // It SHOULDN'T pop up if things are working correctly.
        const slowTimer = setTimeout(() => {
          if (!document.getElementById('loader').classList.contains('fade')) {
            showErr("Loading is taking longer than expected... Contact the Librarian if you can't find the book you're looking for.");
          }
        }, 15000);
        // FETCH - Catch error / CORS issues
        fetch(API, { mode: 'cors' })
          .then(r => { if (!r.ok) throw new Error('Network error: ' + r.status); return r.json(); })
          .then(({ data }) => { clearTimeout(slowTimer); finishInit(data); })
          .catch(err => { console.warn('Fetch failed, falling back to JSONP:', err); clearTimeout(slowTimer); loadViaJSONP(); });
        });

      // Post Initiation - set up Data
      // Add new data here if added to the API
      function finishInit(data){
        document.getElementById('loader').classList.add('fade');

        rows = Array.isArray(data) ? data : [];
        byGenre = new Map();

        for (const r of rows){
          const g = (r?.genre || '').toString().trim();
          const t = (r?.text  || '').toString().trim();
          if (!g || !t) continue;
          if (!byGenre.has(g)) byGenre.set(g, []);
          byGenre.get(g).push({
            text: t,
            url: r?.url || null,
            author: (r?.author || '').toString(),
            date: (r?.date || '').toString(),
            category: (r?.category || '').toString(),
            subcategory: (r?.subcategory || '').toString(),
            trp: (r?.trp || '').toString()  
          });
        }

        // Genre + Search
        renderGenres();
        wireSearch();

        // Filter Clear Button
        clearFiltersBtn.addEventListener('click', e => {
          e.preventDefault();
          catMS.clear(); subMS.clear();
          applyFilter();
        });
      }

      // FALLBACK for CORS Issue, hopefully not needed.
      function loadViaJSONP(){
        const cb = 'initFromAPI_' + Math.random().toString(36).slice(2);
        let script;
        window[cb] = function(payload){
          try { finishInit(payload && payload.data); }
          catch(e){ showErr('JSONP parse error: ' + (e?.message || e)); }
          finally{
            delete window[cb];
            if (script && script.parentNode) script.parentNode.removeChild(script);
          }
        };
        const url = API + (API.includes('?') ? '&' : '?') + 'callback=' + encodeURIComponent(cb);
        script = document.createElement('script');
        script.src = url;
        script.onerror = () => showErr('JSONP load failed. Check your /exec URL.');
        document.head.appendChild(script);
      }

      function showErr(msg){
        document.getElementById('loader').classList.add('fade');
        panelEl.style.display = 'block';
        titleEl.textContent = 'Error';
        listEl.innerHTML = '';
        footerEl.textContent = '';
        errEl.textContent = msg;
        console.error(msg);
      }

      // Rendering Genres
      function renderGenres(){
        genresEl.innerHTML = '';
        const genres = Array.from(byGenre.keys()).sort((a,b)=>a.localeCompare(b));
        if (!genres.length){
          genresEl.innerHTML = `<div class="empty">No genres found.</div>`;
          return;
        }
        genres.forEach(g => {
          const btn = document.createElement('button');
          btn.className = 'genre-btn';
          btn.textContent = g;
          btn.onclick = () => selectGenre(g, btn);
          genresEl.appendChild(btn);
        });
      }

      function selectGenre(genre, btn){
        activeGenre = genre;
        document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // enable search UI
        qEl.disabled = false;
        clearEl.disabled = false;

        // items for this genre
        currentItems = (byGenre.get(genre) || []).slice();
        
        titleEl.textContent = genre;
        panelEl.style.display = 'block';
        qEl.value = '';

        // enable + populate dropdowns
        catMS.setDisabled(false);
        subMS.setDisabled(false);
        
        // Build a category → subcategory index for this genre
        catSubIndex = buildCatSubIndex(currentItems);
        
        // Categories for this genre
        const cats = unique(currentItems.map(it => it.category).filter(Boolean));
        
        // All subcategories in this genre (initially full set)
        const allSubs = unique(currentItems.map(it => it.subcategory).filter(Boolean));
        
        catMS.setOptions(cats);
        subMS.setOptions(allSubs);

        clearFiltersBtn.disabled = false;
        sortSel.disabled = false;
        
        // Set default sort to "Newest" only the first time after load
        if (!sortSel.dataset.initialized) {
          sortSel.value = 'date-newest';
          sortSel.dataset.initialized = 'true';
        } else {
          // Keep user's last selection if they changed it previously
          sortSel.value = sortSel.value || 'date-newest';
        }

        renderList(sortItems(currentItems));
      }

      function renderList(items){
        errEl.textContent = '';
        listEl.innerHTML = '';
        if (!items.length){
          listEl.innerHTML = `<li class="empty">No entries for this genre.</li>`;
          footerEl.textContent = '0 items';
          return;
        }
        for (const it of items){
          const li = document.createElement('li');

          if (it.url){
            const a = document.createElement('a');
            a.href = it.url; a.target = '_blank'; a.rel = 'noopener noreferrer';
            a.textContent = it.text;
            li.appendChild(a);
          } else {
            const title = document.createElement('div');
            title.textContent = it.text;
            title.style.fontSize = '18px';
            li.appendChild(title);
          }

          const meta = document.createElement('div');
          meta.className = 'meta';
          
          // Left meta elements: author + TRP if available
          const left = document.createElement('div');
          left.className = 'left';
          
          let authorHTML = `<div>${it.author ? `Authored by: ${it.author}` : 'Authored by: —'}</div>`;
          if (it.trp) {
            authorHTML += `
              <div class="trp">
                <button class="copy-trp" data-trp="${it.trp}">Copy TRP</button>
              </div>`;
          }
          left.innerHTML = authorHTML;
          
          // Right memta elements: date
          const right = document.createElement('div');
          right.className = 'right';
          right.textContent = it.date ? `Publishing Date: ${it.date}` : 'Publishing Date: —';
          
          meta.appendChild(left);
          meta.appendChild(right);
          li.appendChild(meta);
          
          // Event handler for the Copy TRP button
          if (it.trp) {
            left.querySelector('.copy-trp').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            const trp = btn.dataset.trp;
          
            const ok = await copyToClipboard(trp);
            if (ok) {
              btn.textContent = 'Copied!';
              btn.disabled = true;
              setTimeout(() => {
                btn.textContent = 'Copy TRP';
                btn.disabled = false;
              }, 1200);
            } else {
              // Last-resort prompt so the user can copy manually
              window.prompt('Copy TRP:', trp);
            }
          });

          }
          
          listEl.appendChild(li);
        }
        footerEl.textContent = `${items.length} item${items.length===1?'':'s'}`;
      }

      // Filtering
      function wireSearch(){
        const debounced = debounce(applyFilter, 150);
        qEl.addEventListener('input', debounced);
        clearEl.addEventListener('click', e => { e.preventDefault(); qEl.value=''; applyFilter(); });
        qEl.addEventListener('keydown', e => { if (e.key === 'Escape'){ qEl.value=''; applyFilter(); } });
      }

      function applyFilter(){
        if (!activeGenre) return;

        const q = qEl.value.trim().toLowerCase();

        const selCats = catMS.getSelected();
        const selSubs = subMS.getSelected();
        const hasCat  = selCats.size > 0;
        const hasSub  = selSubs.size > 0;

        const filtered = currentItems.filter(it => {
          const hay = ((it.text||'') + ' ' + (it.author||'')).toLowerCase();
          if (q && !hay.includes(q)) return false;

          if (hasCat && !selCats.has(it.category || '')) return false;
          if (hasSub && !selSubs.has(it.subcategory || '')) return false;

          return true;
        });
        renderList(sortItems(filtered));
      }

      // Helper Functions - Some are patchy and were introduced to fix issues.
      function unique(arr){ return [...new Set(arr)]; }
      function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

      function buildCatSubIndex(items){
        const m = new Map(); // cat -> Set(subs)
        for (const it of items) {
          const cat = (it.category || '').trim();
          const sub = (it.subcategory || '').trim();
          if (!cat) continue;
          if (!m.has(cat)) m.set(cat, new Set());
          if (sub) m.get(cat).add(sub);
        }
        return m;
      }

      function handleCategoryChange(selectedCats){
      // If no categories selected, allow all sub-categories for the active genre
      if (!activeGenre) return;
    
      let allowed = new Set();
      if (selectedCats && selectedCats.size > 0) {
        for (const c of selectedCats) {
          const subs = catSubIndex.get(c);
          if (subs) subs.forEach(s => allowed.add(s));
        }
      } else {
        // All subs in genre
        for (const subs of catSubIndex.values()) {
          subs.forEach(s => allowed.add(s));
        }
      }
    
      // Rebuild Sub-category options; preserve any still-valid selections automatically
      subMS.setOptions([...allowed]); // preserves selected where still valid
    }

      // Custom multi-select dropdown (with guard)
      function makeMultiselect(root, opts = {}){
        if (!root) {
          console.error('Multiselect root not found');
          // No-op shim so the app doesn’t crash
          return { setOptions(){}, setDisabled(){}, clear(){}, getSelected(){ return new Set(); } };
        }
        const label  = root.dataset.label || 'Options';
        const plural = (root.dataset.plural || (label + 's')).toLowerCase();
        const state  = { selected: new Set(), disabled: true };
        
        const control = document.createElement('button');
        control.type = 'button';
        control.className = 'control';
        
        // helper for “no selection” text
        function allText(){ return `All ${plural}`; }
        control.textContent = allText();   // <-- fixes the initial, pre-genre text
        
        const menu = document.createElement('div'); 
        menu.className = 'menu';
        root.append(control, menu);
        
        function displayText(){
          const n = state.selected.size;
          return n ? `${n} selected` : allText();
        }
      
        function setOptions(values, localOpts = {}){
          const preserve = localOpts.preserve !== false; 
          const prev = preserve ? new Set(state.selected) : new Set();
      
          menu.innerHTML = '';
          state.selected.clear();
      
          values.slice().sort((a,b)=>a.localeCompare(b)).forEach(v=>{
            const row = document.createElement('label'); row.className = 'row';
            const cb  = document.createElement('input'); cb.type='checkbox'; cb.value=v;
            const sp  = document.createElement('span');  sp.textContent=v;
            row.append(cb, sp); menu.appendChild(row);
      
            // Restore previous selection if still valid
            if (prev.has(v)) { cb.checked = true; state.selected.add(v); }
      
            cb.addEventListener('change', ()=>{
              cb.checked ? state.selected.add(v) : state.selected.delete(v);
              control.textContent = displayText();
              if (typeof opts.onChange === 'function') {
                opts.onChange(new Set(state.selected));
              }
              if (typeof window.applyFilter === 'function') {
                applyFilter();
              }
            });
          });
          control.textContent = displayText();
        }
      
        function setDisabled(d){
          state.disabled = d;
          root.classList.toggle('disabled', d);
          control.disabled = d;
          if (d) root.classList.remove('open');
        }
        function clear(){
          state.selected.clear();
          menu.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
          control.textContent = displayText();
          if (typeof opts.onChange === 'function') {
            opts.onChange(new Set(state.selected));
          }
          if (typeof window.applyFilter === 'function') {
            applyFilter();
          }
        }
        control.addEventListener('click', ()=>{
          if (state.disabled) return;
          root.classList.toggle('open');
        });
        document.addEventListener('click', (e)=>{
          if (!root.contains(e.target)) root.classList.remove('open');
        });
      
        return {
          setOptions, setDisabled, clear,
          getSelected: () => new Set(state.selected)
        };
      }

      // This workaround was added to fix blocks on the TRP Copy button.
      async function copyToClipboard(text) {
        // Try modern Clipboard API
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (_) { /* fall through */ }
      
        // Fallback: hidden textarea + execCommand
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.opacity = '0';
          ta.style.pointerEvents = 'none';
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return ok;
        } catch (_) {
          return false;
        }
      }

      const MONTHS = {
        january:1,february:2,march:3,april:4,may:5,june:6,
        july:7,august:8,september:9,october:10,november:11,december:12
      };

      // Date parsing to use standard Gilnean AR/BR year markers.
      // Mapping: 2AR = 2, 1AR = 1, 1BR = -1, 2BR = -2 (no year 0).
      // Month/day ordering is preserved inside BOTH eras.
      // Newer dates always have a larger key, regardless of era.
      function parseLoreDate(str){
        if (!str) return null;
        const s = String(str).trim();
        const m = s.match(/^([A-Za-z]+)\s+(\d{1,2})(?:st|nd|rd|th)?\s*,\s*(\d+)\s*([AB]\s*R)$/i);
        if (!m) return null;
      
        const month = MONTHS[m[1].toLowerCase()];
        const day   = parseInt(m[2], 10);
        const year  = parseInt(m[3], 10);
        const era   = m[4].replace(/\s+/g,'').toUpperCase(); // "AR" or "BR"
      
        if (!month || !day || !year || (era !== "AR" && era !== "BR")) return null;
        const within = (month * 100 + day) / 10000; 
        if (era === "AR") return year + within;
        return -year + within;
      }

      // Sort functionality
      function sortItems(items){
        if (!sortSel || sortSel.disabled) return items;
        const val = sortSel.value;
        const norm = s => (s || '').toString().trim().toLowerCase();
      
        switch (val) {
          case 'title-asc':
            return items.slice().sort((a,b)=> norm(a.text).localeCompare(norm(b.text)));
          case 'title-desc':
            return items.slice().sort((a,b)=> norm(b.text).localeCompare(norm(a.text)));
      
          case 'date-newest': {
            // Unparseable dates drop to bottom
            return items.slice().sort((a,b)=>{
              const ka = parseLoreDate(a.date); const kb = parseLoreDate(b.date);
              if (ka == null && kb == null) return 0;
              if (ka == null) return 1;
              if (kb == null) return -1;
              return kb - ka; // higher key = newer
            });
          }
      
          case 'date-oldest': {
            // Unparseable dates drop to bottom
            return items.slice().sort((a,b)=>{
              const ka = parseLoreDate(a.date); const kb = parseLoreDate(b.date);
              if (ka == null && kb == null) return 0;
              if (ka == null) return 1;
              if (kb == null) return -1;
              return ka - kb; // lower key = older
            });
          }
          default:
          return items;
        }
      }
    </script>
  </body>
</html>
